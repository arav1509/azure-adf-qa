{
	"name": "SCD_Type2_DF_copy_test",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "SCD_Source1",
						"type": "DatasetReference"
					},
					"name": "SourceTable"
				},
				{
					"dataset": {
						"referenceName": "SCD_Target1",
						"type": "DatasetReference"
					},
					"name": "MaxSurrogateKey"
				},
				{
					"dataset": {
						"referenceName": "SCD_Target1",
						"type": "DatasetReference"
					},
					"name": "TargetKeyColumn"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "SCD_Target1",
						"type": "DatasetReference"
					},
					"name": "TargetUpdate"
				}
			],
			"transformations": [
				{
					"name": "SurrogateKey1"
				},
				{
					"name": "DerivedColumn1"
				},
				{
					"name": "ActiveFlagTrueColumnFilter",
					"description": "Please Select Target Active column Name and apply filter"
				},
				{
					"name": "TrgColumns"
				},
				{
					"name": "Lookup1"
				},
				{
					"name": "Filter1",
					"description": "Selecting Updated records "
				},
				{
					"name": "UpdateEndDateActiveFlag"
				},
				{
					"name": "Select1"
				},
				{
					"name": "UpdateRows"
				},
				{
					"name": "GetMaxSurrogateKey"
				},
				{
					"name": "DerivedColumn2"
				}
			],
			"script": "parameters{\n\tdf_surrogate_key as string ('select  max(DistrictWise_key) as skey  from   ods.DistrictWiseCases'),\n\tdf_KeyColumn as string\n}\nsource(output(\n\t\tState as string,\n\t\tState_Code as string,\n\t\tDistrict_Key as string,\n\t\tDistrict as string,\n\t\tConfirmed as integer,\n\t\tDistrictWiseConfirmedCasesRank as integer,\n\t\tTotal_state_ConfirmedCases as integer,\n\t\tActive as integer,\n\t\tDistrictWiseActiveCasesRank as integer,\n\t\tTotal_state_ActiveCases as integer,\n\t\tRecovered as integer,\n\t\tDistrictWiseRecoveredCasesRank as integer,\n\t\tTotal_state_RecoveredCases as integer,\n\t\tDeathCases as integer,\n\t\tDistrictWiseDeceasedCasesRank as integer,\n\t\tTotal_state_DeathCases as integer,\n\t\tLoad_date as date\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table') ~> SourceTable\nsource(output(\n\t\tskey as integer\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: ($df_surrogate_key),\n\tformat: 'query') ~> MaxSurrogateKey\nsource(output(\n\t\tDistrictWise_key as integer,\n\t\tState as string,\n\t\tState_Code as string,\n\t\tDistrict_Key as string,\n\t\tDistrict as string,\n\t\tConfirmed as integer,\n\t\tDistrictWiseConfirmedCasesRank as integer,\n\t\tTotal_state_ConfirmedCases as integer,\n\t\tActive as integer,\n\t\tDistrictWiseActiveCasesRank as integer,\n\t\tTotal_state_ActiveCases as integer,\n\t\tRecovered as integer,\n\t\tDistrictWiseRecoveredCasesRank as integer,\n\t\tTotal_state_RecoveredCases as integer,\n\t\tDeathCases as integer,\n\t\tDistrictWiseDeceasedCasesRank as integer,\n\t\tTotal_state_DeathCases as integer,\n\t\tLoad_date as date,\n\t\tStart_date as date,\n\t\tEnd_date as date,\n\t\tIs_Active as string,\n\t\tkey_column as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table') ~> TargetKeyColumn\nGetMaxSurrogateKey keyGenerate(output(surrogate_Key as long),\n\tstartAt: 1L) ~> SurrogateKey1\nSurrogateKey1 derive(surrogate_key_column = skey+surrogate_Key,\n\t\tStart_date = currentUTC(),\n\t\tEnd_Date = toDate('31-DEC-3000','dd-MMM-yyyy'),\n\t\tActive_Flag = 1,\n\t\tKey_Column = md5(concat(District,toString(Confirmed))),\n\t\tlocal1 := $df_KeyColumn) ~> DerivedColumn1\nTargetKeyColumn filter(Is_Active=='1') ~> ActiveFlagTrueColumnFilter\nDerivedColumn2 select(mapColumn(\n\t\ttrg_DistrictWise_key = DistrictWise_key,\n\t\ttrg_State = State,\n\t\ttrg_State_Code = State_Code,\n\t\ttrg_District_Key = District_Key,\n\t\ttrg_District = District,\n\t\ttrg_Confirmed = Confirmed,\n\t\ttrg_DistrictWiseConfirmedCasesRank = DistrictWiseConfirmedCasesRank,\n\t\ttrg_Total_state_ConfirmedCases = Total_state_ConfirmedCases,\n\t\ttrg_Active = Active,\n\t\ttrg_DistrictWiseActiveCasesRank = DistrictWiseActiveCasesRank,\n\t\ttrg_Total_state_ActiveCases = Total_state_ActiveCases,\n\t\ttrg_Recovered = Recovered,\n\t\ttrg_DistrictWiseRecoveredCasesRank = DistrictWiseRecoveredCasesRank,\n\t\ttrg_Total_state_RecoveredCases = Total_state_RecoveredCases,\n\t\ttrg_DeathCases = DeathCases,\n\t\ttrg_DistrictWiseDeceasedCasesRank = DistrictWiseDeceasedCasesRank,\n\t\ttrg_Total_state_DeathCases = Total_state_DeathCases,\n\t\ttrg_Load_date = Load_date,\n\t\ttrg_Start_date = Start_date,\n\t\ttrg_End_date = End_date,\n\t\ttrg_Is_Active = Is_Active,\n\t\ttrg_Key_Column = d_key_column\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> TrgColumns\nDerivedColumn1, TrgColumns lookup(Key_Column == trg_Key_Column,\n\tmultiple: false,\n\tpickup: 'any',\n\tbroadcast: 'auto')~> Lookup1\nLookup1 filter(!isNull(District_Key)) ~> Filter1\nFilter1 derive(trg_End_date_update = currentUTC(),\n\t\ttrg_Active_flag_update = '0') ~> UpdateEndDateActiveFlag\nUpdateEndDateActiveFlag select(mapColumn(\n\t\ttrg_DistrictWise_key,\n\t\ttrg_State,\n\t\ttrg_State_Code,\n\t\ttrg_District_Key,\n\t\ttrg_District,\n\t\ttrg_Confirmed,\n\t\ttrg_DistrictWiseConfirmedCasesRank,\n\t\ttrg_Total_state_ConfirmedCases,\n\t\ttrg_Active,\n\t\ttrg_DistrictWiseActiveCasesRank,\n\t\ttrg_Total_state_ActiveCases,\n\t\ttrg_Recovered,\n\t\ttrg_DistrictWiseRecoveredCasesRank,\n\t\ttrg_Total_state_RecoveredCases,\n\t\ttrg_DeathCases,\n\t\ttrg_DistrictWiseDeceasedCasesRank,\n\t\ttrg_Total_state_DeathCases,\n\t\ttrg_Load_date,\n\t\ttrg_Start_date,\n\t\ttrg_End_date_update,\n\t\ttrg_Active_flag_Update = trg_Active_flag_update,\n\t\ttrg_Key_Column\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select1\nSelect1 alterRow(updateIf(true())) ~> UpdateRows\nSourceTable, MaxSurrogateKey join(1==1,\n\tjoinType:'cross',\n\tbroadcast: 'auto')~> GetMaxSurrogateKey\nActiveFlagTrueColumnFilter derive(d_key_column = md5(concat(District,toString(Confirmed)))) ~> DerivedColumn2\nUpdateRows sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 1,\n\terrorHandlingOption: 'stopOnFirstError',\n\tmapColumn(\n\t\tDistrictWise_key = trg_DistrictWise_key,\n\t\tState = trg_State,\n\t\tState_Code = trg_State_Code,\n\t\tDistrict_Key = trg_District_Key,\n\t\tDistrict = trg_District,\n\t\tConfirmed = trg_Confirmed,\n\t\tDistrictWiseConfirmedCasesRank = trg_DistrictWiseConfirmedCasesRank,\n\t\tTotal_state_ConfirmedCases = trg_Total_state_ConfirmedCases,\n\t\tActive = trg_Active,\n\t\tDistrictWiseActiveCasesRank = trg_DistrictWiseActiveCasesRank,\n\t\tTotal_state_ActiveCases = trg_Total_state_ActiveCases,\n\t\tRecovered = trg_Recovered,\n\t\tDistrictWiseRecoveredCasesRank = trg_DistrictWiseRecoveredCasesRank,\n\t\tTotal_state_RecoveredCases = trg_Total_state_RecoveredCases,\n\t\tDeathCases = trg_DeathCases,\n\t\tDistrictWiseDeceasedCasesRank = trg_DistrictWiseDeceasedCasesRank,\n\t\tTotal_state_DeathCases = trg_Total_state_DeathCases,\n\t\tLoad_date = trg_Load_date,\n\t\tStart_date = trg_Start_date,\n\t\tEnd_date = trg_End_date_update,\n\t\tIs_Active = trg_Active_flag_Update,\n\t\tkey_column = trg_Key_Column\n\t)) ~> TargetUpdate"
		}
	}
}